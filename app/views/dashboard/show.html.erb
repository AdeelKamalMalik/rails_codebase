<% if current_user.contracts.present? %>
  <% show_skeleton =  @effective_contracts.count == 0 %>
  <% empty_table =  @vendors.count == 0 %>
  <% expiry_threshold = 90 %>
  <div class="container mx-auto p-4" id="dashboard" data-controller="contracts">
    <div id="no-contracts-banner" data-contracts-target="noContractsBanner" class="hidden bg-red-100 border-l-4 border-red-100 text-red-700 p-4" role="alert">
      <p>No contracts expiring in 90 days.</p>
    </div>
    <div class="my-8 flex flex-col sm:flex-row gap-4">
      <div class="border rounded-lg p-5 flex-1">
        <p class="text-gray-500 text-lg">Annual Recurring Cost</p>
        <% if show_skeleton %>
          <div class="skeleton my-2 rounded bg-slate-200 animate-pulse"></div>
        <% else %>
          <p class="font-semibold py-2 text-lg"><%= number_to_currency(@vendors.sum(:annual_cost)) %></p>
        <% end %>
      </div>
      <div class="border rounded-lg flex-1 p-5">
        <p class="text-gray-500 text-lg">Monthly Recurring Cost</p>
        <% if show_skeleton %>
          <div class="skeleton my-2 rounded bg-slate-200 animate-pulse"></div>
        <% else %>
          <p class="font-semibold py-2 text-lg"><%= number_to_currency(@vendors.sum(:monthly_cost)) %></p>
        <% end %>
      </div>
      <% if current_user.contracts.not_draft.ending_in(expiry_threshold).count.positive? %>
        <div class="border-2 border-red-300 rounded-lg flex-1 p-5 bg-red-50">
          <div class="flex items-center justify-between">
            <p class="text-red-700 text-lg">Expiring in <%= expiry_threshold %> Days</p>
            <button class="btn btn-small text-red-700 bg-white shadow p-3 rounded-lg" data-action="contracts#Review">Review</button>
          </div>
          <p class="font-bold text-red-700 py-2 text-lg"><%= current_user.contracts.not_draft.ending_in(expiry_threshold).count %> Contracts</p>
        </div>
      <% end %>
    </div>
    <div class="border rounded-lg p-5">
      <div class="filters flex flex-col sm:flex-row item-end gap-5 justify-end">
        <div class="flex items-center">
          <label for="reviewed" class="mr-3">Reviewed</label>
          <%= select_tag 'reviewed', options_for_select([['All', 'all'], ['Reviewed', 'reviewed'], ['Needs Review', 'needs_review']], params[:reviewed]), data: {'filter-type': 'reviewed'}, class: "df-select hidden" %>
        </div>
        <div class="flex items-center">
          <label for="status" class="mr-3">Status</label>
          <%= select_tag 'status', options_for_select([['All', 'all'], ['Active', 'active'], ['Expired', 'expired'], ['Archived', 'archived']], params[:status] || 'active'), data: {'filter-type': 'status'}, class: "df-select hidden" %>
        </div>
        <div class="flex items-center">
          <label for="expiring" class="mr-3 whitespace-nowrap">Expiring in</label>
          <%= select_tag 'expiring', options_for_select([['All', nil], ['30 Days', '30'], ['90 Days', '90'], ['180 Days', '180']], params[:expiring_in]), data: {'filter-type': 'expiring_in'}, class: "df-select hidden" %>
        </div>
      </div>
      <div class="px-4 sm:px-6 lg:px-8">
        <% if empty_table && !show_skeleton %>
          <%= render 'empty_table_state' %>
        <% else %>
          <div class="mt-8 flow-root">
            <div class="-mx-4 -my-2 sm:-mx-6 lg:-mx-8">
              <div class="inline-block min-w-full py-2 align-middle">
                <table class="min-w-full divide-y divide-gray-300 mb-24 dark:text-white">
                  <thead>
                    <tr>
                      <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-500 sm:pl-6 lg:pl-8">Vendors</th>
                      <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-500">
                        <div class="items-center flex">
                          <%= link_to root_path(filter_params(params, params[:sort] == 'review_status' ? '-review_status' : 'review_status')), class: 'text-gray-500 hover:text-gray-600'  do %>
                            Review
                            <div class="flex flex-col ml-2">
                              <%= link_to root_path(filter_params(params, '-review_status')) do %>
                                <%= image_tag 'icons/arrow-up.svg', class: 'mb-1 cursor-pointer' %>
                              <% end %>
                              <%= link_to root_path(filter_params(params, 'review_status')) do %>
                                <%= image_tag 'icons/arrow-down.svg', class: 'cursor-pointer' %>
                              <% end %>
                            </div>
                          <% end %>
                        </div>
                      </th>
                      <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-500 <%= params[:status].eql?('all') ? '' : 'hidden' %>" id="contracts-th-status">
                        <div class="items-center flex">
                          <%= link_to root_path(filter_params(params, params[:sort] == 'status' ? '-status' : 'status')), class: 'text-gray-500 hover:text-gray-600'  do %>
                            Status
                            <div class="flex flex-col ml-2">
                              <%= link_to root_path(filter_params(params, '-status')) do %>
                                <%= image_tag 'icons/arrow-up.svg', class: 'mb-1 cursor-pointer' %>
                              <% end %>
                              <%= link_to root_path(filter_params(params, 'status')) do %>
                                <%= image_tag 'icons/arrow-down.svg', class: 'cursor-pointer' %>
                              <% end %>
                            </div>
                          <% end %>
                        </div>
                      </th>
                      <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-500">
                        <div class="flex items-center">
                          <%= image_tag 'icons/info-light-gray.svg', class: 'mr-2 cursor-pointer' %>
                          <%= link_to root_path(filter_params(params, params[:sort] == 'annual_cost' ? '-annual_cost' : 'annual_cost')), class: 'text-gray-500 hover:text-gray-600'  do %>
                            Annual Cost
                            <div class="flex">
                              <div class="flex flex-col ml-2">
                                <%= link_to root_path(filter_params(params, '-annual_cost')) do %>
                                  <%= image_tag 'icons/arrow-up.svg', class: 'mb-1 cursor-pointer' %>
                                <% end %>
                                <%= link_to root_path(filter_params(params, 'annual_cost')) do %>
                                  <%= image_tag 'icons/arrow-down.svg', class: 'cursor-pointer' %>
                                <% end %>
                              </div>
                            </div>
                          <% end %>
                        </div>
                      </th>
                      <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-500">
                        <div class="items-center flex">
                          <%= image_tag 'icons/info-light-gray.svg', class: 'mr-2 cursor-pointer' %>
                          <%= link_to root_path(filter_params(params, params[:sort] == 'monthly_cost' ? '-monthly_cost' : 'monthly_cost')), class: 'text-gray-500 hover:text-gray-600' do %>
                            Monthly Cost
                            <div class="flex flex-col ml-2">
                              <%= link_to root_path(filter_params(params, '-monthly_cost')) do %>
                                <%= image_tag 'icons/arrow-up.svg', class: 'mb-1 cursor-pointer' %>
                              <% end %>
                              <%= link_to root_path(filter_params(params, 'monthly_cost')) do %>
                                <%= image_tag 'icons/arrow-down.svg', class: 'cursor-pointer' %>
                              <% end %>
                            </div>
                          <% end %>
                        </div>
                      </th>
                      <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-500">
                        <div class="items-center flex">
                          <%= link_to root_path(filter_params(params, params[:sort] == 'end_date' ? '-end_date' : 'end_date')), class: 'text-gray-500 hover:text-gray-600'  do %>
                            End Date
                            <div class="flex flex-col ml-2">
                              <%= link_to root_path(filter_params(params, '-end_date')) do %>
                                <%= image_tag 'icons/arrow-up.svg', class: 'mb-1 cursor-pointer' %>
                              <% end %>
                              <%= link_to root_path(filter_params(params, 'end_date')) do %>
                                <%= image_tag 'icons/arrow-down.svg', class: 'cursor-pointer' %>
                              <% end %>
                            </div>
                          <% end %>
                        </div>
                      </th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-gray-200 bg-white" data-controller="dashboard">
                    <% expiry_threshold_filter = params[:expiring_in] == expiry_threshold.to_s %>
                    <% if show_skeleton %>
                      <tr>
                        <td class="whitespace-nowrap py-4 pl-4 pr-3">
                          <div class="skeleton vendor-icon ml-4 my-1 rounded-lg bg-slate-200 animate-pulse"></div>
                          <div class="skeleton ml-2 my-2 rounded bg-slate-200 animate-pulse"></div>
                        </td>
                        <% 4.times do %>
                          <td class="whitespace-nowrap px-3 py-4"><div class="skeleton ml-4 my-2 rounded bg-slate-200 animate-pulse"></div></td>
                        <% end %>
                      </tr>
                    <% end %>
                    <% @vendors.each do |vendor| %>
                      <% expiring_in_threshold = vendor.ending_in?(expiry_threshold) %>
                      <tr class="vendor-info dark:text-white <%= expiring_in_threshold ? 'contract-expiring' : '' %>" style="<%= expiring_in_threshold && expiry_threshold_filter ? "background-color: #FEF2F280;" : '' %>">
                        <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-bold text-blue-700 sm:pl-6 lg:pl-8 flex">
                          <%= link_to vendor_path(vendor) do %>
                              <%= image_tag "https://img.logo.dev/#{vendor.domain}?token=#{ENV['LOGO_DEV']}&size=43&format=png", { class: 'w-[43px] rounded-lg mr-4 md:block hidden', onerror: "this.src='#{asset_path('icons/empty.svg')}'" } %>
                          <% end %>
                          <div class="flex vendor-name-container <%= expiring_in_threshold ? 'expiring-name' : '' %> <%= expiring_in_threshold && expiry_threshold_filter ? "flex-col" : "items-center" %>">
                            <p class="vendor-name <%= expiring_in_threshold ? 'mb-1' : ''%>"><%= link_to vendor.name, vendor_path(vendor) %></p>
                            <div class="bg-red-50 border h-[28px] border-red-100 text-red-800 px-2 flex items-center rounded-lg contract-expiring-badge <%= expiring_in_threshold && expiry_threshold_filter ? '' : 'hidden' %>">
                              <p class="flex">Expiring Soon
                                <%= image_tag 'icons/expiring-soon.svg', class: 'ml-1' %>
                              </p>
                            </div>
                          </div>
                          <input id="vendor-name-input-classic" type="text" data-vendor-id="<%= vendor.public_id %>" value="<%= vendor.name %>" class="border-gray-200 rounded-lg hidden">
                        </td>
                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-800"><%= vendor.review_status.titleize %></td>
                        <td class="<%= (params[:status].eql?('all')) ? '' : 'hidden' %> whitespace-nowrap px-3 py-4 text-sm text-gray-800" id="contracts-tds-status" ><%= vendor.status.titleize %></td>
                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-800"><%= number_to_currency(vendor.annual_cost) %></td>
                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-800"><%= number_to_currency(vendor.monthly_cost) %></td>
                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-800"><%= vendor.end_date&.strftime("%b %d, %Y") %></td>

                        <td class="relative cursor-pointer whitespace-nowrap py-4 pl-3 pr-4 sm:pr-6 lg:pr-8" data-controller="dropdown">
                          <button type="button" class="flex items-center" id="contract-opts" aria-expanded="true" aria-haspopup="true" data-action="click->dropdown#toggle click@window->dropdown#hide">
                            <%= image_tag "icons/horizontal-three-dots.svg" %>
                          </button>

                          <!-- Dropdown menu -->
                          <div data-dropdown-target="menu"
                            data-transition-enter="transition ease-out duration-200"
                            data-transition-enter-from="opacity-0 translate-y-1"
                            data-transition-enter-to="opacity-100 translate-y-0"
                            data-transition-leave="transition ease-in duration-150"
                            data-transition-leave-from="opacity-100 translate-y-0"
                            data-transition-leave-to="opacity-0 translate-y-1"
                            class="absolute hidden z-20 mt-3 w-56 md:right-[-5rem] origin-top-right rounded-lg bg-white shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none" role="menu" aria-orientation="vertical" aria-labelledby="contract-opts" tabindex="-1">
                            <div class="py-1" role="none" data-action="click->dropdown#toggle">
                              <p class="hover:bg-gray-200 text-slate-600 cursor-pointer px-5 py-3" role="menuitem" tabindex="-1" id="rename-vendor">Rename Vendor</p>
                              <p class="hover:bg-gray-200 text-slate-600 cursor-pointer px-5 py-3" role="menuitem" tabindex="-1" id="add-document" data-controller="settings" data-action="click->settings#openModal" data-modal-id="newContract" data-vendor-id="<%= vendor.public_id %>">Add Document</p>
                              <p class="hover:bg-gray-200 text-slate-600 cursor-pointer px-5 py-3" role="menuitem" tabindex="-1" id="archive-vendor">
                                <%= link_to vendor.archived? ? 'Unarchive Vendor' : 'Archive Vendor', vendor.archived? ? unarchive_vendor_path(vendor) : archive_vendor_path(vendor), { class: 'btn-link text-slate-600 hover:text-slate-600', role: 'menuitem', tabindex: '-1' } %>
                              </p>
                            </div>
                          </div>
                        </td>
                      </tr>
                    <% end %>
                  </tbody>
                </table>
                <div class="flex justify-center mt-6 mb-4 p-4">
                  <%= paginate @vendors %>
                </div>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>
<% else %>
  <div class="container mx-auto p-4">
    <%= render 'empty_table_state' %>
  </div>
<% end %>
<%= render 'contracts/contract_modal' %>
<%= render 'subscriptions/upgrade_modal' %>
